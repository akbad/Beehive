#!/usr/bin/env bash
# 
# Bureau one-shot bootstrap/startup script
# > Run once: ./open-bureau
# > Idempotent (safe to re-run; won't duplicate or kill running resources)
#
# For configuration details, see docs/CONFIGURATION.md

set -euo pipefail

# Change to repo root
REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$REPO_ROOT" || exit 1

# Check dependencies, install correct Python version packages and set up env
bin/ensure-prereqs

# Source shared libraries
source "$REPO_ROOT/bin/lib/logging.sh"
source "$REPO_ROOT/bin/lib/agent-selection.sh"

log_banner "Bureau bootstrap & startup"
log_empty_line

# Determine enabled agents from config
discover_agents
log_empty_line

# Run cleanup if not run recently (silent, non-blocking)
# Note: --quiet suppresses stdout, but stderr (errors) still shows
if command -v uv &> /dev/null; then
    uv run sweep --quiet || true
fi

# --- Run setup scripts (all use directory-based detection) ---

# Run agent setup: 
#   - Wires role prompts into correct locations 
#   - Creates commands and launcher wrappers for directlybusing agents in a main conversation 
#     (i.e. as opposed to as isolated subagents)
# Note: Must be run before tools setup since the agent files mentioned by the PAL
#   configs must exist when PAL is started up
log_empty_line
log_action "Setting up agents and agent launchers/slash commands..."
log_empty_line
agents/scripts/set-up-agents.sh

# Run tools setup & startup, passing along CLI options received
#   - Configures MCPs for each supported coding CLI
#   - Launches MCPs servers and backing containers (for those run as local HTTP servers)
log_action "Setting up tools..."
log_empty_line
tools/scripts/set-up-tools.sh "$@"

# Run configs setup:
#   - Generate coding CLIs' context/config files (w/ device-specific abs paths) 
#   - Symlinks them to the appropriate user-scoped locations for each agent
log_empty_line
log_action "Setting up config files..."
log_empty_line
protocols/scripts/set-up-protocols.sh

log_empty_line
log_banner "All steps complete: Bureau is configured and ready for use!"
log_empty_line

